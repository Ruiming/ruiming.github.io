<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Blog"><title>Angular 最佳实践总结 (一) | Ruiming's Blog</title><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/4.2.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/0.6.0/grids-responsive-min.css"><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.6.3/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.0.0/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Angular 最佳实践总结 (一)</h1><a id="logo" href="/.">Ruiming's Blog</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Angular 最佳实践总结 (一)</h1><div class="post-meta">Sep 29, 2016<span> | </span><span class="category"><a href="/categories/Angular/">Angular</a></span><script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> Hits</span></span></div><a data-disqus-identifier="2016/09/29/Angular 最佳实践总结 (一)/" href="/2016/09/29/Angular 最佳实践总结 (一)/#disqus_thread" class="disqus-comment-count"></a><div class="post-content"><p>搞了快一年的 Angular，Angular 真的是一个非常强大非常齐全非常好用的框架，而且拥有强大的社区支持，虽然踩了很多坑，但是仍然无悔学习了这样一个框架。Angular 2 已经正式发布了，我也打算学 Angular2 去了，现在手头上还有一个用 Angular 的项目，这个项目我是想把我学到的很多 Angular 的最佳实践都用进去，借此我就想干脆也写几篇博客总结下好了，我写的比较散，想到什么就说什么。</p>
<h2 id="使用单次绑定或单向绑定"><a href="#使用单次绑定或单向绑定" class="headerlink" title="使用单次绑定或单向绑定"></a>使用单次绑定或单向绑定</h2><p>从 Angular 1.3 开始就有了 once-time binding，Angular 1.5 开始支持了指令和组件的 one-way binding。看看他们的用法：</p>
<p>单次绑定很简单，加上<code>::</code> 就可以了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&lt;p&gt;&#123;&#123;::vm.title&#125;&#125;&lt;<span class="regexp">/p&gt;</span></div></pre></td></tr></table></figure>
<blockquote>
<p>An expression that starts with <code>::</code> is considered a one-time expression. One-time expressions will stop recalculating once they are stable, which happens after the first digest if the expression result is a non-undefined value (see value stabilization algorithm below).</p>
</blockquote>
<p>当 digest 结束之后并且单次绑定的值不为 undefined 时，这个值将不再被监听。官方称这个算法为 <code>Value stabilization algorithm</code> 还解释了一下。看到这个，再想起 Angular 源码那注释，觉得真的业界良心啊。想具体了解下单次绑定，出门右转 -&gt; <a href="https://docs.angularjs.org/guide/expression" target="_blank" rel="external">docs.angularjs</a></p>
<p>在视图进行单向绑定也很简单，使用 <code>ng-bind</code> 就可以了，这里主要说的是指令和组件中的单向绑定。</p>
<p>其实 Angular1 还是不断再发展，现在最新的是 1.5.9，加了很多新的东西，也做了很多性能优化。单向绑定也是 1.5 之后才引入的新东西。1.5 也引入了一个新的东西叫 component，和 directive 差不多，具体我没用过我也不太了解，不过写法简洁了很多。单向绑定主要就是用于 component 和 directive 的。</p>
<p>随便找个比较简单的例子来说下，</p>
<a id="more"></a>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line"><span class="meta">  'use strict'</span>;</div><div class="line">  <span class="keyword">var</span> app = angular.module(<span class="string">'app'</span>);</div><div class="line"></div><div class="line">  app.component(<span class="string">'menuBar'</span>, &#123;</div><div class="line">    <span class="comment">// defines a two way binding in and out of the component</span></div><div class="line">    bindings: &#123;</div><div class="line">      <span class="attr">brand</span>:<span class="string">'&lt;'</span></div><div class="line">     &#125;,</div><div class="line">    <span class="comment">// Load the template</span></div><div class="line">    templateUrl: <span class="string">'/js/components/appComponent.html'</span>,</div><div class="line">    <span class="attr">controller</span>: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="comment">// A list of menus</span></div><div class="line">      <span class="keyword">this</span>.menu = [&#123;</div><div class="line">        <span class="attr">name</span>: <span class="string">"Home"</span>,</div><div class="line">        <span class="attr">component</span>: <span class="string">"home"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="attr">name</span>: <span class="string">"About"</span>,</div><div class="line">        <span class="attr">component</span>: <span class="string">"about"</span></div><div class="line">      &#125;, &#123;</div><div class="line">        <span class="attr">name</span>: <span class="string">"Contact"</span>,</div><div class="line">        <span class="attr">component</span>: <span class="string">"contact"</span></div><div class="line">      &#125;];</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line">&#125;)();</div></pre></td></tr></table></figure>
<p>单向绑定就上面的 <code>&lt;</code> ，我们知道一般有 <code>@</code>, <code>=</code>, <code>&amp;</code> 三种方式，分别表示绑定字面量，绑定表达式，绑定事件，而新增的 <code>&lt;</code> 是用来实现单向绑定的。上面这段代码是从别的地方找来的，由于我自己没有使用过，所以暂时不过多介绍，晚点搞清楚了再补充下。</p>
<h2 id="谨慎使用-interval"><a href="#谨慎使用-interval" class="headerlink" title="谨慎使用 $interval"></a>谨慎使用 $interval</h2><p>如果我们要实现实时显示当前时间的效果，可以有下面三种方式:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">vm.time = <span class="built_in">Date</span>.now();</div><div class="line"></div><div class="line"><span class="comment">// 方式一</span></div><div class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  vm.time = <span class="built_in">Date</span>.now();</div><div class="line">  $scope.$digest();</div><div class="line">&#125;, <span class="number">1000</span>);</div><div class="line"></div><div class="line"><span class="comment">// 方式二</span></div><div class="line">setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  $scope.$apply(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">    vm.time = <span class="built_in">Date</span>.now();</div><div class="line">  &#125;)</div><div class="line">&#125;, <span class="number">1000</span>);</div><div class="line"></div><div class="line"><span class="comment">// 方式三</span></div><div class="line">$interval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</div><div class="line">  vm.time = <span class="built_in">Date</span>.now();</div><div class="line">&#125;, <span class="number">1000</span>);</div></pre></td></tr></table></figure>
<p>考虑到页面还有其他双向绑定量，你觉得上面三种方式哪种性能消耗会小一点？</p>
<p>我这边测试了下，三种方式导致当前 digest 所执行的 watcher 表达式数量分别是　方式一 (34) &lt; 方式二 (140) = 方式三 (140)。</p>
<img src="/2016/09/29/Angular%20最佳实践总结%20(一)/方式一.png" alt="方式一" title="方式一">
<img src="/2016/09/29/Angular%20最佳实践总结%20(一)/方式二.png" alt="方式二" title="方式二">
<img src="/2016/09/29/Angular%20最佳实践总结%20(一)/方式三.png" alt="方式三" title="方式三">
<p>我感觉有种被骗的感觉，我记得大家都说不要手动调用 <code>$digest</code> 啊要用 <code>$apply</code> 啊… 但事实是这里的方式一是性能最好的，如果要说原因，那是因为<code>$scope.$digest()</code> 只会触发当前 scope 进行 digest，而其余的就会从 <code>$rootScope</code> 下来整个都进行 digest，对于我们这里只是想要实现时间变化的需求来说就显得有点多于了，这种情况下还是方式一合适些。当然了你也可以用原生 JS 来写，但这样就使用不了 Angular 的日期格式化功能了~</p>
<p>不少人认为 Angular 脏检查是轮询，如果不加限制使用 <code>$interval</code>，不就和轮询没区别了。所以能少用就少用，这里不用 <code>$interval</code> 是因为它会在每次循环结束自动调用 <code>$rootScope</code> 上面的 digest，因此使用 setInterval，如果你不触发 digest，那么这个数据的变化是不会同步到视图中的，所以我们手动的触发了当前作用于的 digest。</p>
<h2 id="ng-repeat-使用-trackby-优化"><a href="#ng-repeat-使用-trackby-优化" class="headerlink" title="ng-repeat 使用 trackby 优化"></a>ng-repeat 使用 trackby 优化</h2><p>Angular 会为每个 watch 变量生成一个 <code>hashkey</code>，并使用他来跟踪其值的变化，当我们使用 ng-repeat 时，如果数组的内容发生了变化，Angular 不会重新销毁和渲染整个 DOM，而是找出变化的一部分做出修改，由于 <code>hashkey</code> 是根据节点内容产生的，这意味着我们的数组中不能有完全一样的两个节点存在。并且当数组的子项为对象时，用一个类似的新的数组覆盖它会导致 Angular 销毁并重新渲染整个 DOM。我们试一试便知。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!-- 不使用 track by --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">ng-repeat</span>=<span class="string">"item in items"</span>&gt;</span></div><div class="line">  &#123;&#123;item.value&#125;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 使用 track by --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">p</span> <span class="attr">ng-repeat</span>=<span class="string">"item in vm.items track by item.key"</span>&gt;</span></div><div class="line">  &#123;&#123;item.value&#125;&#125;</div><div class="line"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></div></pre></td></tr></table></figure>
<p>我们在控制器里面这样写看下</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">vm.items = [&#123;<span class="attr">key</span>: <span class="number">1</span>, <span class="attr">value</span>: <span class="number">2</span>&#125;, &#123;<span class="attr">key</span>: <span class="number">3</span>, <span class="attr">value</span>: <span class="number">4</span>&#125;, &#123;<span class="attr">key</span>: <span class="number">5</span>, <span class="attr">value</span>: <span class="number">6</span>&#125;];</div><div class="line">$timeout(<span class="function"><span class="params">()</span> =&gt;</span> vm.items = [&#123;<span class="attr">key</span>: <span class="number">1</span>, <span class="attr">value</span>: <span class="number">2</span>&#125;, &#123;<span class="attr">key</span>: <span class="number">3</span>, <span class="attr">value</span>: <span class="number">4</span>&#125;, &#123;<span class="attr">key</span>: <span class="number">5</span>, <span class="attr">value</span>: <span class="number">6</span>&#125;], <span class="number">2000</span>);</div><div class="line">$timeout(<span class="function"><span class="params">()</span> =&gt;</span> vm.items.push(&#123;<span class="attr">key</span>: <span class="number">7</span>, <span class="attr">value</span>: <span class="number">8</span>&#125;), <span class="number">3000</span>);</div></pre></td></tr></table></figure>
<p>可以自己试一试，然后调出开发者工具查看下 DOM 的变化</p>
<p>结果是：</p>
<ul>
<li><p>不使用 track by</p>
<p>2 秒后重新渲染全部子节点，3 秒后添加渲染了一个新节点。</p>
</li>
<li><p>使用 track by</p>
<p>2 秒后没变化，3秒后添加渲染了一个新节点。</p>
</li>
</ul>
<p>他们的区别就在数组重新赋值上面，还有就是数组必须是一个由对象组成的数组。在有些情况下，我们可能需要使用一个新的数组覆盖旧的数组，而他们之间可能有部分是相同的，如果我们使用 trackBy，Angular 就可以利用这一部分已经渲染好的 DOM，从而达到了优化的目的。</p>
<p>如果没有特别的唯一标识可以指定，也可以直接使用 <code>track by $index</code>，也可以起到一样的作用。</p>
<h2 id="关闭调试信息"><a href="#关闭调试信息" class="headerlink" title="关闭调试信息"></a>关闭调试信息</h2><p>据说这个方法很多人都不知道？</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$compileProvider.debugInfoEnabled(<span class="literal">false</span>);</div></pre></td></tr></table></figure>
<p>这样就可以关闭 Angular 插在视图里面的任何辅助调试信息例如 <code>ng-if</code> 和 <code>ng-repeat</code> 等注释以及 <code>ng-binding</code> 等 CSS 类。上线的时候关掉会比较好一点。</p>
<h2 id="使用超级强大的-interceptors"><a href="#使用超级强大的-interceptors" class="headerlink" title="使用超级强大的 interceptors"></a>使用超级强大的 interceptors</h2><p>这个在做全局请求和相应处理时特别强大，通过它我们可以实现统一修改每个请求的 header，对返回的结果进行处理，全局 HTTP 错误响应处理等等。用法也相当简单：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">$httpProvider.interceptors.push(function($q) &#123;</div><div class="line">  return &#123;</div><div class="line">    'request': function(config) &#123;</div><div class="line">      </div><div class="line">    &#125;,</div><div class="line">    'requestError': function(rejection) &#123;</div><div class="line">      </div><div class="line">    &#125;,</div><div class="line">    ‘response': function(response) &#123;</div><div class="line">      </div><div class="line">    &#125;,</div><div class="line">    'responseError': function(rejection) &#123;</div><div class="line">      </div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>额，举个粟子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    angular</div><div class="line">        .module(<span class="string">'app'</span>)</div><div class="line">        .factory(<span class="string">'tokenInjector'</span>, tokenInjector);</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">function</span> <span class="title">tokenInjector</span>(<span class="params">$injector, $q, $cookies, $cacheFactory, $timeout</span>) </span>&#123;</div><div class="line">        <span class="keyword">let</span> jwt = <span class="literal">undefined</span>;</div><div class="line">        </div><div class="line">        <span class="keyword">return</span> &#123;</div><div class="line">            <span class="attr">request</span>: <span class="function"><span class="keyword">function</span>(<span class="params">config</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span>(<span class="keyword">void</span> <span class="number">0</span> === jwt) &#123;</div><div class="line">                    jwt = $cookies.get(<span class="string">'jwt'</span>);</div><div class="line">                &#125;</div><div class="line">                config.headers[<span class="string">'Authorization'</span>] = <span class="string">"Bearer "</span> + jwt;</div><div class="line">                <span class="keyword">return</span> $q.when(config);</div><div class="line">            &#125;,</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;());</div></pre></td></tr></table></figure>
<p>上面新建了一个 <code>tokenInjector</code>，之后我们这样使用就可以了:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$httpProvider.interceptors.push(tokenInjector);</div></pre></td></tr></table></figure>
<p>作用就是实现每次请求都自动把 token 添加到 header 的 Aturhorization 中。除此之外还可以做好多好多东西，这里就不详细介绍下去了。</p>
<h2 id="使用-ui-router-替代-ngRoute"><a href="#使用-ui-router-替代-ngRoute" class="headerlink" title="使用 ui-router 替代 ngRoute"></a>使用 ui-router 替代 ngRoute</h2><p>自从用了 ui-router 就再也回不去 ngRoute 了，ui-router 使用状态来进行转移，支持多视图和嵌套视图，使用方法更加灵活，并且也有更加丰富的 API。多视图，嵌套视图你知道意味什么吧，这些 ngRoute 做不到，官方现在也是主推 ui-router，前段时间 ui-router 已经出了新的 1.0 版本，相信大部分开发者还是在用老版本吧，可以考虑迁移了，想要了解新版本的迁移事项看<a href="https://ui-router.github.io/guide/ng1/migrate-to-1_0" target="_blank" rel="external">这里</a>。</p>
<p>对于还在使用 ngRoute 的童鞋，我也强烈建议你去使用 ui-router。</p>
<p>多视图和嵌套视图就不多说了，除此之外还有比较强大实用的地方就是 ui-router 提供的生命周期钩子即 <code>$stateChangeStart</code>, <code>$stateChangeSuccess</code>, <code>$stateChangeError</code>，ngRoute 不知道有没有，没有去了解过。下面举个粟子说下用法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$rootScope.$on(<span class="string">"$stateChangeStart"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event, toState, toStateParams, fromState, fromStateParams</span>) </span>&#123;</div><div class="line">    $rootScope.loading = <span class="literal">true</span>;</div><div class="line">&#125;);</div><div class="line">$rootScope.$on(<span class="string">"$stateChangeSuccess"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event, toState, toStateParams, fromState, fromParams</span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span>(ga) &#123;</div><div class="line">    <span class="keyword">let</span> re = <span class="regexp">/\&#123;(.*?)&#125;/g</span>, url;</div><div class="line">    <span class="keyword">if</span>(<span class="built_in">Object</span>.keys(toStateParams).length &gt; <span class="number">0</span>) &#123;</div><div class="line">      url = toState.url.replace(re, <span class="built_in">Object</span>.values(toStateParams).reduce(<span class="function">(<span class="params">pre, curr</span>) =&gt;</span> curr));</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      url = toState.url;</div><div class="line">    &#125;</div><div class="line">    ga(<span class="string">'send'</span>, <span class="string">'pageview'</span>, url);</div><div class="line">  &#125;</div><div class="line">  $rootScope.loading = <span class="literal">false</span>;</div><div class="line">&#125;);</div><div class="line">$rootScope.$on(<span class="string">"$stateChangeError"</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event, toState, toStateParams, fromState, fromParams, error</span>) </span>&#123;</div><div class="line">  $rootScope.loading = <span class="literal">false</span>;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>其实上面应该时比较 tricky 的做法，作用就是全局视图切换动画以及让 google analysis 工作，从 <code>stateChangeStart</code> 开始，<code>isLoading</code> 变为 true 直到 <code>stateChangeSuccess</code> 的时候变为 false。我们把 <code>isLoading</code> 挂在 <code>$rootScope</code> 上面方便使用，用这个变量就可以判断是否加载一个 Loading 的 DOM。</p>
<p>其次，由于单页应用特性，google analysis 只被加载一次从而无法实时反馈用户当前所访问的页面，我们可以手动进行调用，上面就是用法了，也是每次在成功状态变化之后发送当前 url。</p>
<p>不过遗憾的是这个 API 在 ui-router 1.0 版本废弃了，不过 ui-router 1.0 目录下带了另一个文件，引入这个文件即可以继续使用。我猜测 ui-router 1.0 应该是有更好的解决方案来替代它，详细的可以自己去了解下。</p>
<p>另外还想说的一个地方就是 ui-router 的 resolve 功能，允许我们在控制器初始化之前先获取和处理数据，如果 resolve 的东西是一个 promise，如果 promise 状态为 rejected，那么视图就不会被成功切换。基于此我们可以把视图需要的一些 HTTP 请求放到 ui-router 的 resolve 上面来做，然后再注入到控制器给控制器使用，并且这样还可以避免数据未到达时视图的数据显示问题以及数据请求失败后的问题。举个粟子：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">.state(<span class="string">'posts'</span>, &#123;</div><div class="line">  <span class="attr">url</span>: <span class="string">'/posts/:type'</span>,</div><div class="line">  <span class="attr">templateUrl</span>: <span class="string">'posts/posts_tpl.html'</span>,</div><div class="line">  <span class="attr">controller</span>: <span class="string">'PostsController as vm'</span>,</div><div class="line">  <span class="attr">resolve</span>: &#123;</div><div class="line">    <span class="attr">posts</span>: <span class="function"><span class="keyword">function</span>(<span class="params">Posts, $stateParams, $q</span>) </span>&#123;</div><div class="line">      <span class="keyword">let</span> defer = $q.defer();</div><div class="line">      <span class="keyword">if</span>([<span class="string">'unread'</span>, <span class="string">'mark'</span>].indexOf($stateParams.type) !== <span class="number">-1</span>) &#123;</div><div class="line">        defer.resolve(Posts.get(&#123;<span class="attr">type</span>: $stateParams.type&#125;).$promise);</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        defer.reject(<span class="string">'参数不正确'</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">return</span> defer.promise;</div><div class="line">    &#125;,</div><div class="line">  &#125;</div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<p>这是一个路由的状态，这里应用了 promise 的反模式，其实我自己也不是特别了解，之前看到一篇文章再批评这个。我回去学习下再补充。</p>
<p>这个地方的作用就是判断 state 传进的参数是否符合要求，如果不符合要求则无法加载，符合要求的话就会去请求资源，如果请求失败的话视图也不会被加载，即状态不会切换成功，如果请求成功我们可以再控制器依赖注入 <code>posts</code> 取得返回结果。</p>
</div><script type="text/javascript" src="/js/share.js?v=0.0.0" async></script><a data-url="https://ruiming.github.io/2016/09/29/Angular 最佳实践总结 (一)/" data-id="cix8nltpm000bnvcm0b8vbwrv" class="article-share-link">分享到</a><div class="tags"><a href="/tags/Angular/">Angular</a></div><div class="post-nav"><a href="/2016/10/07/编译原理与PEG-js/" class="pre">编译原理与PEG.js</a><a href="/2016/09/24/Angular1之折腾记/" class="next">Angular1之折腾记</a></div><div id="disqus_thread"><script>var disqus_shortname = 'ruiming';
var disqus_identifier = '2016/09/29/Angular 最佳实践总结 (一)/';
var disqus_title = 'Angular 最佳实践总结 (一)';
var disqus_url = 'https://ruiming.github.io/2016/09/29/Angular 最佳实践总结 (一)/';
(function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();</script><script id="dsq-count-scr" src="//ruiming.disqus.com/count.js" async></script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" class="search-form"><input type="text" name="q" maxlength="20" placeholder="Search"/><input type="hidden" name="sitesearch" value="https://ruiming.github.io"/></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Angular/">Angular</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/HTTP/">HTTP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Node/">Node</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/PEG/">PEG</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/React/">React</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Underscore/">Underscore</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Vue/">Vue</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Webpack/">Webpack</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/安全/">安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/网络安全/">网络安全</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/还不知道分什么类好/">还不知道分什么类好</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/JWT/" style="font-size: 15px;">JWT</a> <a href="/tags/Hack/" style="font-size: 15px;">Hack</a> <a href="/tags/JavaScript/" style="font-size: 15px;">JavaScript</a> <a href="/tags/Front-end/" style="font-size: 15px;">Front end</a> <a href="/tags/Underscore/" style="font-size: 15px;">Underscore</a> <a href="/tags/DNS/" style="font-size: 15px;">DNS</a> <a href="/tags/HTTPS/" style="font-size: 15px;">HTTPS</a> <a href="/tags/HTTP/" style="font-size: 15px;">HTTP</a> <a href="/tags/TCP-IP/" style="font-size: 15px;">TCP/IP</a> <a href="/tags/Webkit/" style="font-size: 15px;">Webkit</a> <a href="/tags/ESlint/" style="font-size: 15px;">ESlint</a> <a href="/tags/Koa/" style="font-size: 15px;">Koa</a> <a href="/tags/Node/" style="font-size: 15px;">Node</a> <a href="/tags/Angular/" style="font-size: 15px;">Angular</a> <a href="/tags/Vue/" style="font-size: 15px;">Vue</a> <a href="/tags/Vuex/" style="font-size: 15px;">Vuex</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/V8/" style="font-size: 15px;">V8</a> <a href="/tags/Sort/" style="font-size: 15px;">Sort</a> <a href="/tags/co/" style="font-size: 15px;">co</a> <a href="/tags/Compiler/" style="font-size: 15px;">Compiler</a> <a href="/tags/PEG-js/" style="font-size: 15px;">PEG.js</a> <a href="/tags/Webpack/" style="font-size: 15px;">Webpack</a> <a href="/tags/React/" style="font-size: 15px;">React</a> <a href="/tags/Redux/" style="font-size: 15px;">Redux</a> <a href="/tags/Gulp/" style="font-size: 15px;">Gulp</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最新文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2016/12/28/2016-总结/">2016 总结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/30/浅谈-co-库/">浅谈 co 库</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/21/正确使用-JS-的-sort-方法/">正确使用 JS 的 sort 方法</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/17/聊聊-Webpack-使用/">聊聊 Webpack 使用</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/15/使用-Koa2-开发小结/">使用 Koa2 开发小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/08/使用-ESLint-规范你的代码/">使用 ESLint 规范你的代码</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/11/05/拥抱 vue 和 vuex/">拥抱 vue 和 vuex</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/14/关于前后端分离鉴权的思考/">关于前后端分离鉴权的思考</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/10/07/编译原理与PEG-js/">编译原理与PEG.js</a></li><li class="post-list-item"><a class="post-list-link" href="/2016/09/29/Angular 最佳实践总结 (一)/">Angular 最佳实践总结 (一)</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//ruiming.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">© <a href="/." rel="nofollow">Ruiming's Blog.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.0" async></script><link rel="stylesheet" type="text/css" href="/css/jquery.fancybox.css?v=0.0.0"><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
ga('create','UA-81637252-1','auto');ga('send','pageview');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>